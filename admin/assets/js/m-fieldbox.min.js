import{getCounter as e,dialogBox as t,getHTMLTemplate as s,animateCollapse as o,eventList as d,elBinder as i,animate as n}from"../../../lib/assets/js/general/m-general.min.js?v=1727180045";import{keydownMoveIcon as r}from"../../../lib/assets/js/m-utils.min.js?v=1727180045";const l=jQuery,a={handle:".fbox-move-handle",placeholder:"rds-sortable-placeholder",connectWith:".rds-field-boxes",forceHelperSize:!0,receive:function(e,t){const s=e.target.closest(".rds-field-box"),o=null===s?"root":s.getAttribute("data-type");v.list[t.item[0].id].wrappers.includes(o)||l(t.sender).sortable("cancel")},over:function(e,t){const s=e.target.closest(".rds-field-box"),o=null===s?"root":s.getAttribute("data-type");v.list[t.item[0].id].wrappers.includes(o)?document.querySelector(".rds-sortable-placeholder").classList.toggle("hide",!1):document.querySelector(".rds-sortable-placeholder").classList.toggle("hide",!0)}},c=e=>{const t=document.querySelectorAll(`.rds-field-box:not([id="${e.id}"] .rds-field-box)`);let s=0;for(let o=0;o<t.length;++o)if(t[o].id==e.id){s=o;break}if(s<=0)return;let o,d,i,n=0,r=!1,l=s;for(o=v.list[t[s].id],l--;!r&&l>=0;){if(d=v.list[t[l].id],i="root"==d.parentID?"root":v.list[d.parentID].type,d.parentID==o.parentID){n=l,r=!0;break}if(o.wrappers.includes(d.type)&&d.id!=o.parentID){n=l,r=!0;break}if(o.wrappers.includes(i)){n=l,r=!0;break}l--}r&&(o.wrappers.includes(d.type)&&d.id!=o.parentID?t[n].querySelector(".rds-field-boxes").append(t[s]):d.parentID==o.parentID||["tabs","tab","container"].includes(d.type)?t[n].parentElement.insertBefore(t[s],t[n]):t[n].parentElement.append(t[s]))},u=e=>{const t=document.querySelectorAll(`.rds-field-box:not([id="${e.id}"] .rds-field-box)`);let s=0;for(let o=0;o<t.length;++o)if(t[o].id==e.id){s=o;break}if(s>=t.length)return;let o,d,i,n=0,r=!1,l=s;if(o=v.list[t[s].id],s==t.length-1&&"root"!=o.parentID&&o.wrappers.includes("root"))document.querySelector(".rds-field-boxes").append(t[s]);else{for(l++;!r&&l<t.length;){if(d=v.list[t[l].id],i="root"==d.parentID?"root":v.list[d.parentID].type,"root"!=d.parentID&&o.wrappers.includes(i)){n=l,r=!0;break}if(o.wrappers.includes(d.type)){n=l,r=!0;break}if(!["tabs","tab","container"].includes(d.type)&&o.wrappers.includes(i)){n=l,r=!0;break}l++}if(r)if(o.wrappers.includes(d.type))t[n].querySelector(".rds-field-boxes").prepend(t[s]);else if(o.parentID==d.parentID){const e=t[n].nextSibling;null===e?t[n].parentElement.appendChild(t[s]):e.parentElement.insertBefore(t[s],e)}else t[n].parentElement.insertBefore(t[s],t[n])}},p=e=>{const t=e.target,s=v.get(t.closest(".rds-field-box").id);"ArrowUp"!=e.code&&"ArrowLeft"!=e.code||(e.preventDefault(),c(s)),"ArrowDown"!=e.code&&"ArrowRight"!=e.code||(e.preventDefault(),u(s)),t.focus()},b=e=>{const t=new h;t.type="text",t.node.classList.add("expanded"),t.parentID=e,t.node.scrollIntoView({behavior:"smooth",block:"start",inline:"start"}),t.elBinded("type").focus()};class h extends i{node;#e={text:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},checkbox:{classes:"",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},color:{classes:"",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},date:{classes:"",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},number:{classes:"small-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},email:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},password:{classes:"regular-text",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},phone:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},radio:{classes:"",fields:["label","name","description","classes","options","shortcode"],wrappers:["root","container","tab"]},select:{classes:"",fields:["label","name","description","classes","options","shortcode"],wrappers:["root","container","tab"]},textarea:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},url:{classes:"regular-text",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},media:{classes:"",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},editor:{classes:"",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},container:{classes:"rg-border-t",fields:["label","name","description","classes","fields"],wrappers:["root","container","tab"]},tabs:{classes:"",fields:["label","name","description","classes","fields"],wrappers:["root","container","tab"]},tab:{classes:"rd-pt-8",fields:["label","name","description","classes","fields"],wrappers:["tabs"]}};#t={};#s=new d;#o=new d;#d;get id(){return this.#d}get options(){let e={};if(this.#e[this.type].fields.includes("options"))for(const t of this.node.querySelector(".rds-field-option-list").children)e[t.id]=this.#s.get(t.id);return e}get attributes(){let e={};for(const t of this.node.querySelector(".rds-field-attribute-list").children)e[t.id]=this.#o.get(t.id);return e}get wrappers(){return this.#e[this.type].wrappers}get fields(){let e={};if(this.#e[this.type].fields.includes("fields"))for(const t of this.node.querySelector(".rds-field-boxes").children)e[t.id]=v.get(t.id);return e}set parentID(e=0){let t=null;e&&(t=document.querySelector("#"+e+" > .rds-group-field > .rds-field-boxes")),t||(t=document.querySelector(".rds-fields-content > .rds-field-boxes")),t.appendChild(this.node);const s=v.get(e);s&&(["tabs","tab","container"].includes(s.type)&&(s.elBinded("type").disabled=!0,s.elBinded("type").classList.add("rds-bold")),"tabs"==s.type&&(this.type="tab",this.elBinded("type").disabled=!0,this.elBinded("type").classList.add("rds-bold")));v.dispatchEvent(new CustomEvent("added",{bubbles:!0,detail:{item:this}}))}get parentID(){const e=this.node.parentElement.closest(".rds-field-box");return null===e?"root":e.id}constructor(){super(),this.#d="fb"+e(),this.#i(),this.node.querySelectorAll("[data-fbox-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-fbox-handle"))})),this.node.querySelectorAll("[data-type-handle]").forEach((e=>{this.#t[e.getAttribute("data-type-handle")]=e})),this.#n(),this.elBinded("name").setAttribute("data-valid-handle","field_name"),v.add(this)}#i(){this.node=s("fieldbox-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[fbid]",this.id)}addOption(e=null){const t=new m(this.id);return e instanceof Object&&(t.default=e.default,t.value=e.value,t.text=e.text),this.#s.add(t),t}addAttribute(e=null){const t=new f(this.id);return e instanceof Object&&(t.name=e.name,t.value=e.value),this.#o.add(t),t}getValues(){const e={type:this.type,name:this.name,label:this.label,description:this.description,default_value:this.default_value,classes:this.classes,options:[],attributes:[],fields:[]};["radio","select"].includes(e.type)&&Object.values(this.options).forEach((t=>{e.options.push({default:t.default,value:t.value,text:t.text})})),Object.values(this.attributes).forEach((t=>{e.attributes.push({name:t.name,value:t.value})}));if(["tabs","tab","container"].includes(e.type))for(const t of this.node.querySelector(".rds-field-boxes").children)e.fields.push(v.get(t.id).getValues());return e}selects(e){return this.node.querySelectorAll(".el-wrapper "+e)}select(e){return this.node.querySelector(".el-wrapper "+e)}remove(){const e=this;o(this.node,100,(function(){!function(){const t=v.get(e.parentID);e.node.querySelectorAll(".rds-field-box"),e.node.querySelectorAll(".rds-field-box").forEach((e=>{v.remove(e.id)})),v.remove(e.id),e.node.remove(),t&&0==t.node.querySelectorAll(".rds-field-boxes .rds-field-box").length&&(t.elBinded("type").removeAttribute("disabled"),t.elBinded("type").classList.remove("rds-bold"))}()}))}dialogRemoveFieldBox(){const e=this,s=new t("dlg-remove-field");return s.title="Delete Confirmation",s.content="Are you sure you want to remove this field?",s.addButton(["Yes","No"]),s.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&e.remove(),t.target.close()})),s.addEventListener("open",(t=>{const s=e.select(".rds-field-box-header .move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash"),e.node.classList.add("removing")})),s.addEventListener("close",(t=>{const s=e.select(".rds-field-box-header .move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.classList.remove("removing"),e.select("button.remove-field").focus(),t.target.node.remove()})),s}dialogRemoveAttribute(e){const s=this,o=new t("dlg-remove-att");return o.title="Delete Confirmation",o.content="Are you sure you want to remove this attribute?",o.addButton(["Yes","No"]),o.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&s.#r(e),t.target.close()})),o.addEventListener("open",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash")})),o.addEventListener("close",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.querySelector("button.remove-attr").focus(),t.target.node.remove()})),o}dialogRemoveOption(e){const s=this,o=new t("dlg-remove-opt");return o.title="Delete Confirmation",o.content="Are you sure you want to remove this option?",o.addButton(["Yes","No"]),o.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&s.#l(e),t.target.close()})),o.addEventListener("open",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash")})),o.addEventListener("close",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.querySelector("button.remove-option").focus(),t.target.node.remove()})),o}#r(e){const t=this;o(e.node,60,(function(){t.#o.remove(e.id),e.node.remove()}))}#l(e){const t=this;o(e.node,60,(function(){t.#s.remove(e.id),e.node.remove()}))}#n(){const e=this;this.addEventListener("input",(t=>{const s=t.detail.handle;if("type"==s){const s=this.elBinded("type"),o=s.options[s.selectedIndex].text;this.node.setAttribute("data-type",this.type),e.fbox_type=o;const d=this.node.querySelector(".rds-group-field > .rds-btn-add-wrapper > button.btn-group-new-field");"tabs"==this.type?(d.textContent="Add New Tab",d.setAttribute("data-add","tab")):(d.textContent="Add New Field",d.setAttribute("data-add","field")),["select","radio"].includes(t.detail.value)&&0==Object.keys(e.options).length&&(e.addOption(),e.addOption()),e.name||(e.classes=e.#e[t.detail.value].classes);let i=!1;Object.keys(e.#t).forEach((function(s){i=!e.#e[t.detail.value].fields.includes(s),e.#t[s].classList.toggle("hide",i)}))}"label"!=s&&"name"!=s||(e.fbox_title=e.label?e.label:e.name),"name"==s&&t.detail.element.setAttribute("data-val",t.detail.element.value)})),this.addEventListener("buttonClick",(t=>{const s=t.detail.handle;if("btn_move_up"==s&&(c(e),e.node.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"}),n.fadeIn(e.node,{delay:200})),"btn_move_down"==s&&(u(e),e.node.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"}),n.fadeIn(e.node,{delay:200})),"btn_duplicate"==s){const t=g(e.getValues(),e.parentID,{before:(e,t)=>{t.name=""},after:(e,t)=>{e.node.classList.toggle("expanded",!0)}});e.node.after(t.node),t.node.scrollIntoView({behavior:"smooth",block:"start",inline:"start"}),t.elBinded("label").focus()}if("btn_remove_field"==s){if(!e.label&&!e.name)return void e.remove();e.dialogRemoveFieldBox().open()}if("btn_add_field"==s&&b(e.id),"title_wrapper"!=s&&"btn_expanse_collapse"!=s||e.node.classList.toggle("expanded"),"btn_clear_opt_default"==s&&(e.select(".opt-default input:checked").checked=!1),"btn_generate_id"==s){const t=(e.label?e.label:e.type).toLowerCase().replace(/[\W_]+/g,"_");e.name=t;const s=function(){Object.values(v.list).forEach((function(o){if(o.id!=e.id&&o.name==e.name)return e.name==t?e.name=t+"_1":e.name=t+"_"+(Number(e.name.split("_").pop())+1),void s()}))};s(),e.elBinded("name").setAttribute("data-val",e.name)}})),this.select(".rds-field-box-header .move-handle-icon").addEventListener("keydown",p),this.elBinded("move_handle").addEventListener("focus",(t=>{e.elBinded("title_wrapper").classList.toggle("rg-ml-8",!0),e.node.querySelector(".rds-field-box-header").classList.toggle("rds-moving",!0)})),this.elBinded("move_handle").addEventListener("blur",(t=>{e.elBinded("title_wrapper").classList.toggle("rg-ml-8",!1),e.node.querySelector(".rds-field-box-header").classList.toggle("rds-moving",!1)})),this.#a(),this.#c()}#a(){const e=this;this.elBinded("btn_add_attribute").onclick=function(){e.addAttribute().elBinded("name").focus()},this.#o.addEventListener("single",(function(){e.select("table.rds-field-attributes-table").classList.remove("hide"),e.select(".rds-field-attribute-footer").appendChild(e.select("button.btn-add-attribute"))})),this.#o.addEventListener("empty",(function(){e.select("table.rds-field-attributes-table").classList.add("hide"),e.select(".rds-field-attribute-header").appendChild(e.select("button.btn-add-attribute"))})),this.#o.addEventListener("add",(function(t){const s=t.detail.item;s instanceof f?(s.node.querySelector(".remove-attr").onclick=()=>{s.name||s.value?e.dialogRemoveAttribute(s).open():e.#r(s)},s.node.querySelector(".move-handle-icon").addEventListener("keydown",r)):t.preventDefault()}))}#c(){const e=this;this.elBinded("btn_add_option").onclick=()=>{e.addOption().elBinded("value").focus()},this.#s.addEventListener("add",(function(t){const s=t.detail.item;s instanceof m?(s.node.querySelector(".remove-option").onclick=()=>{s.value||s.text?e.dialogRemoveOption(s).open():e.#l(s)},s.node.querySelector(".move-handle-icon").addEventListener("keydown",r)):t.preventDefault()}))}}class f extends i{node;#d;get id(){return this.#d}#u;set fbid(e){this.#u=e}get fbid(){return this.#u}#i(){this.#d="att"+e(),this.node=s("field-attribute-row-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[attid]",this.id)}constructor(e){super(),this.#u=e,this.#i(),this.node.querySelectorAll("[data-att-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-att-handle"))})),document.querySelector("#"+e+" table.rds-field-attributes-table tbody").appendChild(this.node)}}class m extends i{node;#d;get id(){return this.#d}#u;set fbid(e){this.#u=e}get fbid(){return this.#u}#i(){this.#d="opt"+e(),this._bind.default={},this._bind.value={},this._bind.text={},this.node=s("field-option-row-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[optid]",this.id)}constructor(e){super(),this.#u=e,this.#i(),this.node.querySelectorAll("[data-opt-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-opt-handle"))})),document.querySelector("#"+e+" table.rds-field-options-table tbody").appendChild(this.node)}}const v=new d,y=()=>{v.addEventListener("add",(e=>{!e.detail.item instanceof h&&e.preventDefault()})),v.getValues=()=>{const e=[];for(const t of document.querySelector(".rds-field-boxes").children)e.push(v.get(t.id).getValues());return e},l(".rds-field-boxes").sortable(a),v.addEventListener("empty",(()=>{document.querySelector(".rds-fields-header .rds-fields-title").appendChild(document.querySelector(".btn-new-field"))})),v.addEventListener("single",(()=>{document.querySelector(".rds-btn-add-wrapper.rds-btn-add-footer").appendChild(document.querySelector(".btn-new-field")),document.querySelector(".expand-collapse-wrapper").classList.add("hide")})),v.addEventListener("many",(()=>{document.querySelector(".expand-collapse-wrapper").classList.remove("hide")})),v.addEventListener("added",(e=>{l(e.detail.item.node.querySelector(".rds-field-boxes")).sortable(a),l(e.detail.item.select("table.rds-field-attributes-table tbody")).sortable({handle:".move-handle"}),l(e.detail.item.select("table.rds-field-options-table tbody")).sortable({handle:".move-handle"})})),document.querySelector("button.btn-new-field").onclick=()=>{b()};const e=e=>{Object.values(v.list).forEach((t=>{t.node.classList.toggle("expanded",e)}))};document.querySelector("button.btn-expand-all").onclick=()=>e(!0),document.querySelector("button.btn-collapse-all").onclick=()=>e(!1)},g=(e,t,s={})=>{const o=new h,d=s.hasOwnProperty("before")?s.before:null,i=s.hasOwnProperty("after")?s.after:null;return"function"==typeof d&&d(o,e),o.parentID=t,e.options.forEach((e=>{o.addOption(e)})),e.attributes.forEach((e=>{o.addAttribute(e)})),o.type=e.type,o.name=e.name,o.label=e.label,o.description=e.description,o.default_value=e.default_value,o.classes=e.classes,e.fields.forEach((e=>{g(e,o.id,s)})),"function"==typeof i&&i(o,e),o};export{h as fieldBox,v as fBoxList,y as fBoxInit,g as createFBox};