import{fBoxList as e}from"./m-fboxlist.min.js?v=1727180045";import{getCounter as t,dialogBox as i,getHTMLTemplate as d,animateCollapse as s,eventList as n,elBinder as o,animate as l,addCSSLink as a}from"../general/m-general.min.js?v=1727180045";import{keydownMoveIcon as r}from"../m-utils.min.js?v=1727180045";import{fBoxMoveUp as c,fBoxMoveDown as u,keydownMoveIconFBox as h,clickAddNew as b,createFBox as p}from"./m-functions.min.js?v=1727180045";import{types as f}from"./m-types.min.js?v=1727180045";import"./m-sortable.min.js?v=1727180045";a("rds-fieldbox-style",new URL("./fieldbox.min.css?v=1727180045",import.meta.url)),e.addEventListener("add",(e=>{!e.detail.item instanceof m&&e.preventDefault()}));class m extends o{node;#e={};#t=new n;#i=new n;#d;get id(){return this.#d}get options(){let e={};if(f[this.type].fields.includes("options"))for(const t of this.node.querySelector(".rds-field-option-list").children)e[t.id]=this.#t.get(t.id);return e}get attributes(){let e={};for(const t of this.node.querySelector(".rds-field-attribute-list").children)e[t.id]=this.#i.get(t.id);return e}get wrappers(){return f[this.type].wrappers}get fields(){let t={};if(f[this.type].fields.includes("fields"))for(const i of this.node.querySelector(".rds-field-boxes").children)t[i.id]=e.get(i.id);return t}set parentID(t=0){let i=null;t&&(i=document.querySelector("#"+t+" > .rds-group-field > .rds-field-boxes")),i||(i=document.querySelector(".rds-fields-content > .rds-field-boxes")),i.appendChild(this.node);const d=e.get(t);d&&(["tabs","tab","container"].includes(d.type)&&(d.elBinded("type").disabled=!0,d.elBinded("type").classList.add("rds-bold")),"tabs"==d.type&&(this.type="tab",this.elBinded("type").disabled=!0,this.elBinded("type").classList.add("rds-bold")));e.dispatchEvent(new CustomEvent("added",{bubbles:!0,detail:{item:this}}))}get parentID(){const e=this.node.parentElement.closest(".rds-field-box");return null===e?"root":e.id}constructor(){super(),this.#d="fb"+t(),this.#s(),this.node.querySelectorAll("[data-fbox-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-fbox-handle"))})),this.node.querySelectorAll("[data-type-handle]").forEach((e=>{this.#e[e.getAttribute("data-type-handle")]=e})),this.#n(),this.elBinded("name").setAttribute("data-valid-handle","field_name"),e.add(this)}#s(){this.node=d("fieldbox-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[fbid]",this.id)}addOption(e=null){const t=new y(this.id);return e instanceof Object&&(t.default=e.default,t.value=e.value,t.text=e.text),this.#t.add(t),t}addAttribute(e=null){const t=new v(this.id);return e instanceof Object&&(t.name=e.name,t.value=e.value),this.#i.add(t),t}getValues(){const t={type:this.type,name:this.name,label:this.label,description:this.description,default_value:this.default_value,classes:this.classes,options:[],attributes:[],fields:[]};["radio","select"].includes(t.type)&&Object.values(this.options).forEach((e=>{t.options.push({default:e.default,value:e.value,text:e.text})})),Object.values(this.attributes).forEach((e=>{t.attributes.push({name:e.name,value:e.value})}));if(["tabs","tab","container"].includes(t.type))for(const i of this.node.querySelector(".rds-field-boxes").children)t.fields.push(e.get(i.id).getValues());return t}selects(e){return this.node.querySelectorAll(".el-wrapper "+e)}select(e){return this.node.querySelector(".el-wrapper "+e)}remove(){const t=this;s(this.node,100,(function(){!function(){const i=e.get(t.parentID);t.node.querySelectorAll(".rds-field-box"),t.node.querySelectorAll(".rds-field-box").forEach((t=>{e.remove(t.id)})),e.remove(t.id),t.node.remove(),i&&0==i.node.querySelectorAll(".rds-field-boxes .rds-field-box").length&&(i.elBinded("type").removeAttribute("disabled"),i.elBinded("type").classList.remove("rds-bold"))}()}))}dialogRemoveFieldBox(){const e=this,t=new i("dlg-remove-field");return t.title="Delete Confirmation",t.content="Are you sure you want to remove this field?",t.addButton(["Yes","No"]),t.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&e.remove(),t.target.close()})),t.addEventListener("open",(t=>{const i=e.select(".rds-field-box-header .move-handle-icon");i.classList.remove("dashicons-move"),i.classList.add("dashicons-trash"),e.node.classList.add("removing")})),t.addEventListener("close",(t=>{const i=e.select(".rds-field-box-header .move-handle-icon");i.classList.remove("dashicons-trash"),i.classList.add("dashicons-move"),e.node.classList.remove("removing"),e.select("button.remove-field").focus(),t.target.node.remove()})),t}dialogRemoveAttribute(e){const t=this,d=new i("dlg-remove-att");return d.title="Delete Confirmation",d.content="Are you sure you want to remove this attribute?",d.addButton(["Yes","No"]),d.addEventListener("buttonClick",(i=>{"Yes"==i.detail.text&&t.#o(e),i.target.close()})),d.addEventListener("open",(t=>{const i=e.node.querySelector(".move-handle-icon");i.classList.remove("dashicons-move"),i.classList.add("dashicons-trash")})),d.addEventListener("close",(t=>{const i=e.node.querySelector(".move-handle-icon");i.classList.remove("dashicons-trash"),i.classList.add("dashicons-move"),e.node.querySelector("button.remove-attr").focus(),t.target.node.remove()})),d}dialogRemoveOption(e){const t=this,d=new i("dlg-remove-opt");return d.title="Delete Confirmation",d.content="Are you sure you want to remove this option?",d.addButton(["Yes","No"]),d.addEventListener("buttonClick",(i=>{"Yes"==i.detail.text&&t.#l(e),i.target.close()})),d.addEventListener("open",(t=>{const i=e.node.querySelector(".move-handle-icon");i.classList.remove("dashicons-move"),i.classList.add("dashicons-trash")})),d.addEventListener("close",(t=>{const i=e.node.querySelector(".move-handle-icon");i.classList.remove("dashicons-trash"),i.classList.add("dashicons-move"),e.node.querySelector("button.remove-option").focus(),t.target.node.remove()})),d}#o(e){const t=this;s(e.node,60,(function(){t.#i.remove(e.id),e.node.remove()}))}#l(e){const t=this;s(e.node,60,(function(){t.#t.remove(e.id),e.node.remove()}))}#n(){const t=this;this.addEventListener("input",(e=>{const i=e.detail.handle;if("type"==i){const i=this.elBinded("type"),d=i.options[i.selectedIndex].text;this.node.setAttribute("data-type",this.type),t.fbox_type=d;const s=this.node.querySelector(".rds-group-field > .rds-btn-add-wrapper > button.btn-group-new-field");"tabs"==this.type?(s.textContent="Add New Tab",s.setAttribute("data-add","tab")):(s.textContent="Add New Field",s.setAttribute("data-add","field")),["select","radio"].includes(e.detail.value)&&0==Object.keys(t.options).length&&(t.addOption(),t.addOption()),t.name||(t.classes=f[e.detail.value].classes);let n=!1;Object.keys(t.#e).forEach((function(i){n=!f[e.detail.value].fields.includes(i),t.#e[i].classList.toggle("hide",n)}))}"label"!=i&&"name"!=i||(t.fbox_title=t.label?t.label:t.name),"name"==i&&e.detail.element.setAttribute("data-val",e.detail.element.value)})),this.addEventListener("buttonClick",(i=>{const d=i.detail.handle;if("btn_move_up"==d&&(c(t),t.node.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"}),l.fadeIn(t.node,{delay:200})),"btn_move_down"==d&&(u(t),t.node.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"}),l.fadeIn(t.node,{delay:200})),"btn_duplicate"==d){const e=p(t.getValues(),t.parentID,{before:(e,t)=>{t.name=""},after:(e,t)=>{e.node.classList.toggle("expanded",!0)}});t.node.after(e.node),e.node.scrollIntoView({behavior:"smooth",block:"start",inline:"start"}),l.fadeIn(e.node,{delay:200}),e.elBinded("label").focus()}if("btn_remove_field"==d){if(!t.label&&!t.name)return void t.remove();t.dialogRemoveFieldBox().open()}if("btn_add_field"==d&&b(t.id),"title_wrapper"!=d&&"btn_expanse_collapse"!=d||t.node.classList.toggle("expanded"),"btn_clear_opt_default"==d&&(t.select(".opt-default input:checked").checked=!1),"btn_generate_id"==d){const i=(t.label?t.label:t.type).toLowerCase().replace(/[\W_]+/g,"_");t.name=i;const d=function(){Object.values(e.list).forEach((function(e){if(e.id!=t.id&&e.name==t.name)return t.name==i?t.name=i+"_1":t.name=i+"_"+(Number(t.name.split("_").pop())+1),void d()}))};d(),t.elBinded("name").setAttribute("data-val",t.name)}})),this.select(".rds-field-box-header .move-handle-icon").addEventListener("keydown",h),this.elBinded("move_handle").addEventListener("focus",(e=>{t.elBinded("title_wrapper").classList.toggle("rg-ml-8",!0),t.node.querySelector(".rds-field-box-header").classList.toggle("rds-moving",!0)})),this.elBinded("move_handle").addEventListener("blur",(e=>{t.elBinded("title_wrapper").classList.toggle("rg-ml-8",!1),t.node.querySelector(".rds-field-box-header").classList.toggle("rds-moving",!1)})),this.#a(),this.#r()}#a(){const e=this;this.elBinded("btn_add_attribute").onclick=function(){e.addAttribute().elBinded("name").focus()},this.#i.addEventListener("single",(function(){e.select("table.rds-field-attributes-table").classList.remove("hide"),e.select(".rds-field-attribute-footer").appendChild(e.select("button.btn-add-attribute"))})),this.#i.addEventListener("empty",(function(){e.select("table.rds-field-attributes-table").classList.add("hide"),e.select(".rds-field-attribute-header").appendChild(e.select("button.btn-add-attribute"))})),this.#i.addEventListener("add",(function(t){const i=t.detail.item;i instanceof v?(i.node.querySelector(".remove-attr").onclick=()=>{i.name||i.value?e.dialogRemoveAttribute(i).open():e.#o(i)},i.node.querySelector(".move-handle-icon").addEventListener("keydown",r)):t.preventDefault()}))}#r(){const e=this;this.elBinded("btn_add_option").onclick=()=>{e.addOption().elBinded("value").focus()},this.#t.addEventListener("add",(function(t){const i=t.detail.item;i instanceof y?(i.node.querySelector(".remove-option").onclick=()=>{i.value||i.text?e.dialogRemoveOption(i).open():e.#l(i)},i.node.querySelector(".move-handle-icon").addEventListener("keydown",r)):t.preventDefault()}))}}class v extends o{node;#d;get id(){return this.#d}#c;set fbid(e){this.#c=e}get fbid(){return this.#c}#s(){this.#d="att"+t(),this.node=d("field-attribute-row-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[attid]",this.id)}constructor(e){super(),this.#c=e,this.#s(),this.node.querySelectorAll("[data-att-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-att-handle"))})),document.querySelector("#"+e+" table.rds-field-attributes-table tbody").appendChild(this.node)}}class y extends o{node;#d;get id(){return this.#d}#c;set fbid(e){this.#c=e}get fbid(){return this.#c}#s(){this.#d="opt"+t(),this._bind.default={},this._bind.value={},this._bind.text={},this.node=d("field-option-row-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[optid]",this.id)}constructor(e){super(),this.#c=e,this.#s(),this.node.querySelectorAll("[data-opt-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-opt-handle"))})),document.querySelector("#"+e+" table.rds-field-options-table tbody").appendChild(this.node)}}export{m as fieldBox,e as fBoxList,p as createFBox};